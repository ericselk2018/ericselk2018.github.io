<title>FAST Pinball Tester</title>
<style>
	body {
		background-color: black;
		color: white;
		font-size: 30px;
		font-family: sans-serif;
	}
	a {
		color: white;
		text-decoration: underline;
		cursor: pointer;
	}
	p {
		margin: 0;
		padding: 0;
		margin-bottom: 30px;
	}
	.view {
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		text-align: center;
		padding: 5%;
	}
	.box {
		padding: 5%;
		margin: 10%;
		border: dotted 10px white;
		border-radius: 20px;
	}
	button {
		width: 200px;
		padding: 20px;
		font: inherit;
		display: block;
		margin: 20px auto;
		border-radius: 20px;
		font-weight: bold;
	}
	.tabs {
		display: flex;
		gap: 30px;
		margin-bottom: 30px;
	}
	.tabs .active {
		color: lime;
	}
	.eventsBox {
		margin-top: 60px;
		font-size: 20px;
	}
	.logBox {
		margin-top: 60px;
		font-size: 20px;
	}
	.log {
		white-space: pre;
		height: 200px;
		overflow-x: auto;
		overflow-y: scroll;
		margin: 20px;
		border: solid 1px white;
		padding: 20px;
		border-radius: 20px 0 0 20px;
	}
	.tip {
		font-size: 20px;
		padding: 0 5%;
	}
	.hint {
		font-size: 16px;
		padding: 0 5%;
	}
	textarea {
		width: 100%;
		height: 200px;
	}
	input, select {
		font: inherit;
		padding: 20px;
		border-radius: 20px;
		font-weight: bold;
		width: 200px;
	}
	.boardTypeSelect {
		width: unset;
	}
	table {
		margin-top: 30px;
	}
</style>

<div id="getChromeDiv" class="view" style="display: none">
	<div class="box">
		<a href="https://www.google.com/chrome/" id="chromeOnly">Get Chrome</a>, it is the only browser that supports
		serial communcation and was used for testing (Edge and browsers based on Chrome might work too, but your current
		browser will not).
	</div>
</div>

<div id="selectHardwareDiv" class="view" style="display: none">
	<div class="box">
		<div>Which FAST hardware are you using?</div>
		<button onclick="setHardware('Neuron')">Neuron</button>
		<button onclick="setHardware('Nano')">Nano</button>
	</div>
</div>

<div id="requestPortDiv" class="view" style="display: none">
	<div class="box">
		<p>
			<span id="hardwareNameDiv"></span>
			(<a tabindex="0" onclick="setHardware('')">change</a>)
		</p>
		Connect USB cable to FAST controller, then
		<a tabindex="0" onclick="location.reload()">click here to retry</a> or if your first time
		<a tabindex="0" onclick="requestPort()">click here to select port</a>.
	</div>
</div>

<div id="mainDiv" style="display: none">
	<p>Connected to <span id="hardwareNameDiv2"></span> (<a tabindex="0" onclick="setHardware('')">change</a>)</p>
	<div class="tabs">
		<a id="switchesTab" tabindex="0" onclick="setView('switches')">Switches</a>
		<a id="driversTab" tabindex="0" onclick="setView('drivers')">Drivers</a>
		<a id="ledsTab" tabindex="0" onclick="setView('leds')">LEDs</a>
	</div>
	<div id="switchesDiv" style="display: none">
		<div class="tip">
			<b>Optional:</b> Enter switch IDs and names below for a better experience.<br />
			<div class="hint">
				Required Syntax:<br />
				1 Left Inlane Rollover<br />
				8 My Switch with ID of 8<br />
				982 My Switch with ID of 982<br />
				400 whatever name I want goes here<br />
			</div>
			<br />
			<textarea oninput="handleTextChange()" id="textarea"></textarea>
		</div>

		<div class="eventsBox">
			<div>Switch Change Log:</div>
			<div id="events" class="log"></div>
		</div>
	</div>
	<div id="driversDiv" style="display: none">
		<div class="tip">
			<b>Warning:</b> Use this section with care, it will trigger coils to fire, use at your own risk.<br />
			<table>
				<tr>
					<td>Coil ID<br />(0 to 255)</td>
					<td>Pulse Time<br />(milliseconds 1 to 255)</td>
					<td>Pulse Power %<br />(1 to 100)</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<input id="coilId" oninput="updateTapCoilCommand()" />
					</td>
					<td>
						<input id="coilMs" oninput="updateTapCoilCommand()" />
					</td>
					<td>
						<input id="coilPercent" oninput="updateTapCoilCommand()" />
					</td>
					<td>
						<button onclick="handleTapCoilClick()">Pulse Coil</button>
					</td>
				</tr>
			</table>
			<div>
				This command will be sent to pulse coil:<br />
				<div id="tapCoilCommand"></div>
			</div>
		</div>
	</div>
	<div id="ledsDiv" style="display: none">
		<div class="tip">
			<b>Warning:</b> Use this section with care, it will trigger LEDs to light, use at your own risk.<br />
			<p>
				<div>Board Type</div>
				<select id="boardTypeSelect" class="boardTypeSelect">
					<option value="84">FP-EXP-0081 (256 LEDs, 0 Servos)</option>
					<option value="B4">FP-EXP-0071 (156 LEDs, 4 Servos)</option>
				</select>
			</p>
			<p>
				<div>Board ID</div>
				<select id="boardIdSelect">
					<option>0</option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
				</select>
			</p>
			<table>
				<tr>
					<td>Red %<br />(1 to 100)</td>
					<td>Green %<br />(1 to 100)</td>
					<td>Blue %<br />(1 to 100)</td>
					<td>Fade Duration<br />(milliseconds)</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<input id="redPercent" />
					</td>
					<td>
						<input id="greenPercent" />
					</td>
					<td>
						<input id="bluePercent" />
					</td>
					<td>
						<input id="fadeDuration" />
					</td>
					<td>
						<button onclick="handleLEDClick()">Update LED</button>
					</td>
				</tr>
			</table>
		</div>
	</div>

	<div class="logBox">
		Communication Log:
		<div class="log" id="log"></div>
	</div>

	<script>
		const usbVendorId = 11914;
		const usbProductId = 4155;
		const hardwareModel = 8192;
		const requestPortDiv = document.getElementById('requestPortDiv');
		const getChromeDiv = document.getElementById('getChromeDiv');
		const selectHardwareDiv = document.getElementById('selectHardwareDiv');
		const hardwareNameDiv = document.getElementById('hardwareNameDiv');
		const hardwareNameDiv2 = document.getElementById('hardwareNameDiv2');
		const mainDiv = document.getElementById('mainDiv');
		const textarea = document.getElementById('textarea');
		const events = document.getElementById('events');
		const coilIdInput = document.getElementById('coilId');
		const coilMsInput = document.getElementById('coilMs');
		const coilPercentInput = document.getElementById('coilPercent');
		const log = document.getElementById('log');
		const tapCoilCommand = document.getElementById('tapCoilCommand');
		const switchesDiv = document.getElementById('switchesDiv');
		const switchesTab = document.getElementById('switchesTab');
		const driversDiv = document.getElementById('driversDiv');
		const driversTab = document.getElementById('driversTab');
		const ledsDiv = document.getElementById('ledsDiv');
		const ledsTab = document.getElementById('ledsTab');
		textarea.value = localStorage.getItem('text');

		const addLog = (message) => (log.textContent += message + '\r\n');
		const addEvent = (message) => (events.textContent += message + '\r\n');

		const handleTextChange = () => {
			localStorage.setItem('text', textarea.value);
		};

		const handleTapCoilClick = () => {
			tapCoil();
		};

		const handleLEDClick = () => {
			updateLED();
		}

		const requestPort = async () => {
			// Forget all ports first so that we only have one port to deal with.
			const ports = await navigator.serial.getPorts();
			for (const port of ports) {
				await port.forget();
			}

			navigator.serial
				.requestPort({ filters: [{ usbVendorId, usbProductId }] })
				.then(() => location.reload())
				.catch((error) => alert(error));
		};

		// Zero padding and uppercase doesn't seem to be needed,
		//  but it makes things match the docs and maybe easier to read in logs.
		const toHex = (number) => {
			const hex = number.toString(16).toUpperCase();
			if (hex.length % 2) {
				return '0' + hex;
			}
			return hex;
		};

		const formatCommand = (command, ...args) => {
			const filterUndefined = (array) => {
				return array.filter((item) => item !== undefined);
			};

			return `${command}:${filterUndefined(args)
				.map((arg) => toHex(arg))
				.join(',')}`;
		};

		const clamp = ({ value, min, max }) => Math.max(Math.min(value, max), min);

		const percentToByteValue = (value) => Math.round(clamp({ value, min: 0, max: 1 }) * 255);

		const setView = (value) => {
			localStorage.setItem('view', value);
			switchesDiv.style.display = value === 'switches' ? 'block' : 'none';
			switchesTab.className = value === 'switches' ? 'active' : '';
			driversDiv.style.display = value === 'drivers' ? 'block' : 'none';
			driversTab.className = value === 'drivers' ? 'active' : '';
			ledsDiv.style.display = value === 'leds' ? 'block' : 'none';
			ledsTab.className = value === 'leds' ? 'active' : '';
		};
		setView(localStorage.getItem('view') || 'switches');

		createTapCoilCommand = () => {
			const coilId = parseInt(coilIdInput.value);
			if (isNaN(coilId) || coilId < 0 || coilId > 255) {
				return '-invalid coil ID';
			}
			const ms = parseInt(coilMsInput.value);
			if (isNaN(ms) || ms <= 0 || ms > 255) {
				return '-milliseconds must be between 1 and 255';
			}
			const percent = parseInt(coilPercentInput.value);
			if (isNaN(percent) || percent <= 0 || percent > 100) {
				return '-percent must be greater than 0 and less than or equal to 100';
			}

			const trigger = 0b1001001; // enabled, one-shot, manual
			const driverMode = 0x10; // pulse
			const neuron = localStorage.getItem('hardware') === 'Neuron';
			return formatCommand(
				neuron ? 'DL' : 'DN',
				coilId,
				trigger,
				0,
				driverMode,
				ms,
				percentToByteValue(percent / 100),
				0,
				0,
				0
			);
		};

		updateTapCoilCommand = () => {
			tapCoilCommand.innerText = createTapCoilCommand();
		};

		setHardware = async (value) => {
			const ports = await navigator.serial.getPorts();
			for (const port of ports) {
				await port.forget();
			}
			localStorage.setItem('hardware', value);
			location.reload();
		};

		if (!'serial' in navigator) {
			getChromeDiv.style.display = 'flex';
		} else if (!localStorage.getItem('hardware')) {
			selectHardwareDiv.style.display = 'flex';
		} else {
			init = async () => {
				const hardware = localStorage.getItem('hardware');
				hardwareNameDiv.innerText = hardware;
				hardwareNameDiv2.innerText = hardware;
				const ports = await navigator.serial.getPorts();
				if (ports.length !== 0) {
					requestPortDiv.style.display = 'flex';
					return;
				}
				mainDiv.style.display = 'block';

				const port = ports[0];

				await port.open({ baudRate: 921600 });

				const writer = port.writable.getWriter();

				const writeLine = async (args) => {
					const { text } = args;
					addLog('wrote: ' + text);
					await writer.write(new TextEncoder().encode(text + '\r'));
				};

				const writeCommand = async (command, ...args) => {
					const text = formatCommand(command, args);
					await writeLine({ text });
				};

				const clear = async () => {
					await writeLine({ text: Array(2048).fill(' ').join('') });
				};

				const configureHardware = async () => {
					// Nano doesn't use the CH command.
					const neuron = hardware.value === 'Neuron';
					if (neuron) {
						await writeCommand('CH', hardwareModel, 1);
					}
				};

				tapCoil = async () => {
					const command = createTapCoilCommand();
					if (command.startsWith('-')) {
						return;
					}
					await writeCommand('WD', 500);
					await writeLine(command);
				};

				updateLED = async() => {
					//
				}

				let received = '';
				port.readable.pipeTo(
					new WritableStream({
						write: (chunk) => {
							const lines = (received + new TextDecoder().decode(chunk)).split('\r');
							lines.forEach((line, index) => {
								// The last part doesn't end with \r so we just save it for now.  We will process it after we get the ending \r
								if (index === lines.length - 1) {
									received = line;
								} else {
									addLog('read: ' + line);
									if (line.startsWith('/L:') || line.startsWith('-L:')) {
										const closed = line[0] === '-';
										const switchId = parseInt(line.substring('/L:'.length), 16);
										const switchInfo = (() => {
											try {
												return textarea.value
													.replace(/\r\n/g, '\r')
													.replace(/\n/g, '\r')
													.split('\r')
													.map((text) => {
														const parts = text.split(' ');
														const id = parts[0];
														const name = parts.slice(1).join(' ');
														return { id, name };
													});
											} catch {
												addEvent('invalid syntax for switch IDs and names');
											}
										})();
										const info = switchInfo?.find((aSwitch) => aSwitch.id === switchId.toString());
										const message = `${info ? info.name : `switch id ${switchId}`} ${
											closed ? 'closed' : 'open'
										}`;
										try {
											// This doesn't seem to work unless it is in response to a user gesture, but maybe you can
											//  toggle some security feature in your browser and get a spoken message when switches are hit.
											const utter = new SpeechSynthesisUtterance(message);
											utter.rate = 5;
											window.speechSynthesis.cancel();
											window.speechSynthesis.speak(utter);
										} catch {
											// sorry, speach doesn't work for you, but you can read the log
										}
										addEvent(message);
									}
								}
							});
						},
					})
				);

				await clear();
				await configureHardware();
			};
			init();
		}
	</script>
</div>
